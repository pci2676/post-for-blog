# AWS 네트워크 서비스

## 종류

vpc: 클라우드 가상의 데이터 센터

vpn: 온프레미스 환경 데이터 센터와 vpc간의 연결

direct connect: 온프레미스 데이터 센터와 vpc 전용선 연결

elb: 관리형 로드밸랜서 서비스

route53: 관리형 dns 서비스 

</br>

## VPC

사용자가 정의한 가상의 네트워크 환경 (논리적 격리)

사용자 별 네트워크 제거 가능

- 리젼 선정 및 ip 대역 지정
- 용도에 맞는 subnet 분리
- 라우팅 테이블
- SG, network acl
- GW

온 프레미스 데이터 센터와 연결

#### 생성과정

1. 리젼생성, IP대역 결정
2. AZ에 subnet 생성
3. 라우팅 설정
4. I/O 바운드 설정

#### 리젼, AZ, VPC의 이해

- 리젼: 데이터 센터가 위치하는 물리적인 지역을 의미함
  - 그 리젼에 가용성을 위한 두개 이상의 AZ(가용 영역)이 존재한다.
    - AZ는 한 개 이상의 초고속 네트워크로 연결된 데이터 센터 클러스터가 존재한다.

**CIDR(사이더) 를 이용하여 IP레인지를 설정한다.**

- A,B,C 클래스 0.0.0./16 -> 전방 16개의 비트를 네트워크 아이디로 사용하고 나머지 비트를 호스트 아이디로 사용한다.
  - 즉 subnet mask 는 255.255.0.0 이 된다.
  - 이 경우 사용 가능한 IP는 2^16개가 된다.

서비스 확장을 고려하여 충분히 큰 사이더를 지정하는 것이 좋으나 무조건 큰 사이더가 좋지는 않아 여러가지 고려할 점이 있다. 사이더는 생성 후 변경이 불가능하다.

---

서브넷은 사이더로 설정한 IP레인지를 쪼개서 사용하는 것으로 생각하면 된다. 따라서 AZ내에 서브넷을 생성할 때 VPC에서 설정한 IP레인지 내의 서브넷을 만들게 된다.

이렇게 하는 이유는 VPC 내에 위치한 리소스 별로 용도가 다르기 때문인데 특정 리소스는 VPC 외부와 통신을 할 필요가, 다른 리소스는 VPC 내부와만 통신을 해야하는 경우가 있다.

각 서브넷은 예약된 5개의 IP를 제외하고 사용할 수 있다.

----

AWS의 라우트 테이블은 메인 라우트 테이블(로컬 라우팅)과 커스텀 라우트 테이블이 있다.

메인 라우트 테이블은 동일 VPC 내 서로 다른 서브넷간의 통신을 위해 존재한다.

예시를 들어보면 10.0.0.1/8 과 10.0.0.2/8 은 같은 네트워크 영역에 존재하기 때문에 통신이 가능하다. 하지만 10.0.1.1/8 은 앞선 두 개의 리소스와 네트워크 영역이 다르기 때문에 원래대로라면 통신을 할 수 없다.

이렇게 네트워크 영역이 다르더라도 같은 VPC 에 속한다면 통신을 할 수 있게 해주는 것이 메인 라우트 테이블의 역할이다.

자동으로 메인 라우트 테이블이 생성되서 VPC 내 모든 서브넷에 암시적으로 적용이 된다. 

이렇게 VPC 내의 서브넷 간의 통신은 해결되었다. 커스텀 라우트 테이블은 VPC 의 특정 서브넷은 외부와 통신할 필요가 있을 때 외부와 라우트 설정을 한뒤 사용하면 된다. 커스텀 라우트 테이블은 명시적으로 서브넷에 연결해주어야 한다.

---

네트워크의 트래픽 통제는 다음과 같은 방법을 이용한다.

1. 라우트 테이블
   - 서브넷 단위 라우팅 통제
2. 네트워크 ACL (엑세스 제어 목록)
   - 서브넷 단위에 인바운드, 아웃바운드 제어 목록 적용
   - Allow / Deny 를 반드시 설정해줘야 한다.
   - 서브넷의 방화벽
3. SG
   - 인스턴스 단위로 Allow 설정을 할 수 있다.

---

#### VPC 확장 시나리오

##### 인터넷 확장

VPC에 인터넷 게이트 웨이를 연결하고 라우트 테이블에 포함시키면 된다. 이렇게 인터넷 게이트 웨이와 연결된 서브넷은 퍼블릭 서브넷이라 불리게 된다.

##### NAT 게이트 웨이 (EIP - 변경되지 않는 IP 필수)

프라이빗 서브넷에 위치한 리소스들이 단방향으로만 통신할 수 있도록 한다. 예를 들어 프라이빗 서브넷에 위치한 배포용 젠킨스가 깃헙 혹은 깃랩과 같은 소스코드를 저장한 곳에 접근하여 소스코드를 다운로드 받을 수 있도록 하는 것이다. 요청을 보내서 응답을 받을 수 있는 측은 프라이빗 서브넷에 위치한 리소스뿐인 것이다.

EIP는 기본 5개만 생성할 수 있도록 할당되지만 추가할 수 있다.

##### 온프레미스 환경

VPN 게이트 웨이를 이용하여 site-to-site vpn 을 이용하여 암호화 터널을 구성한다.

AWS Direct Connet를 이용하여 전용회선으로 직접 연결한다.

##### VPC 간 확장 = VPC peering

동일 리젼 내 VPC 간 연결을 지원한다. 하나의 피어링만 제공할 수 있으며 VPC 간 IP가 중복될 수 없다.

172.31.0.0/16 에서 10.55.0.0/16 으로 피어링을 하게 되면

172.31.0.0/16 의 라우트 테이블에 10.55.0.0/16 이 destination 으로 추가된다.

이때 만약 10.0.0.0/24 VPC가 10.0.0.0/16 VPC와 피어링을 한다면? 10.0.0.0/24 라우트 테이블에 10.0.0.0/16 이 추가되고 10.0.0.0/24 에게 들어와야하는 요청이 10.0.0.0/16 으로 전송되어 버리는 경우가 발생할 수 있다. 그래서 무조건 크게 설정한다고 좋은것이 아니다. 그런데 애시당초 피어링 조건에 맞지 않아서 위와 같이 피어링이 될 일은 없다.

##### AWS 서비스(S3, SQS, SNS...)와 연계

VPN Endpoint 게이트 웨이 타입으로 IAM 정책을 정의해 놓을 수 있다.

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "SqsAccess",
            "Effect": "Allow",
            "Action": [
                "sqs:DeleteMessage",
                "sqs:GetQueueUrl",
                "sqs:DeleteMessageBatch",
                "sqs:SendMessageBatch",
                "sqs:ReceiveMessage",
                "sqs:SendMessage",
                "sqs:GetQueueAttributes"
            ],
            "Resource": [
                "arn:aws:sqs:ap-northeast-2:000011112222:foo-sqs"
            ]
        }
    ]
}
```

혹은 AWS 서비스에 IAM 정책을 특정 VPC 엔드포인트에서만 접근 할 수 있도록 정의할 수도 있다.

인터페이스 타입은 프라이빗 링크를 통해서 다른 VPC의 엔드포인트를 이용하여 리소스에 접근하는 방법이다. 인터넷 게이트 웨이, 나트 게이트 웨이 없이 바로 접근할 수 있다.

#### VPC 관리

##### VPC Flow Logs

네트워크 패킷을 수집하여 CloudWatch 로그 그룹에 기록한다.

</br>

## DirectConnect

AWS와 온프레미스를 연결할 수 있게 해준다.

</br>

## Transit Gateway

full mash 토폴로지를 간단하게 하나의 게이트 웨이로 해결해준다.

</br>

## ELB

로드밸런싱 지원을 해준다.

3가지 종류가 존재한다.

- ALB - 7계층 (HTTP, HTTPS)
- NLB - TCP workload
- CLB - classic

### ALB

listener와 target group 으로 구성되고 컨텐츠(Path, Host)기반으로 라우팅을 할 수 있다.

![image](https://user-images.githubusercontent.com/13347548/119752382-e4c08380-bed7-11eb-9c5d-d9e5d192e457.png)

- Listner
  - port, protocol 지정
  - ALB당 최소 1개 지정
    - 최대 50개
  - 컨텐츠 기반 Rule 지정
    - host or path 기반
- Target Group
  - ALB 밑단 타겟들의 논리적 그룹
    - ec2
    - ecs, eks
    - ip 주소
    - lambda

### NLB

4계층 로드 밸런서이다. TCP 프로토콜을 지원한다.

커넥션을 길게 잡고 있는 app에 적합하다 (ex. 게임, 채팅)

---

ELB의 IP 주소는 지속적으로 변경되기 때문에 DNS Name Record를 사용하는것이 좋다.

</br>

## Route 53

DNS 서비스

글로벌 트래픽을 관리할 때 사용할 수 있다.

public, pirvate hosted zone 으로 나뉘고 public은 도메인 구입이 필요하다.

